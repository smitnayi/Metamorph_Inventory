<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Metamorph Metals{% endblock %}</title>
    {% load static %}
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#10b981", // Emerald 500
                        "primary-dark": "#047857", // Emerald 700
                        "background-light": "#f9fafb", // Gray 50
                        "background-dark": "#111827",  // Gray 900
                        "surface-light": "#ffffff",
                        "surface-dark": "#1f2937",     // Gray 800
                        "text-light": "#111827",
                        "text-dark": "#f3f4f6",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                    },
                },
            },
        };
    </script>
    <style>
        .spark-chart-positive-dark {
            --start-color: #38e07b33;
            --end-color: #38e07b00;
            --stroke-color: #38e07b;
        }

        .spark-chart-positive-light {
            --start-color: #38e07b33;
            --end-color: #38e07b00;
            --stroke-color: #38e07b;
        }

        .spark-chart-negative-dark {
            --start-color: #ef444433;
            --end-color: #ef444400;
            --stroke-color: #ef4444;
        }

        .spark-chart-negative-light {
            --start-color: #ef444433;
            --end-color: #ef444400;
            --stroke-color: #ef4444;
        }

        [x-cloak] {
            display: none !important;
        }

        /* Navigation styles without @apply */
        .nav-link {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            transition: color 0.2s;
        }

        .dark .nav-link {
            color: #d1d5db;
        }

        .nav-link:hover {
            color: #38e07b;
        }

        .dark .nav-link:hover {
            color: #38e07b;
        }

        .nav-link.active {
            color: #38e07b;
            background-color: rgba(56, 224, 123, 0.1);
        }

        .mobile-nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            border-radius: 0.375rem;
            color: #374151;
            transition: color 0.2s;
        }

        .dark .mobile-nav-link {
            color: #d1d5db;
        }

        .mobile-nav-link:hover {
            color: #38e07b;
        }

        .dark .mobile-nav-link:hover {
            color: #38e07b;
        }

        .mobile-nav-link.active {
            color: #38e07b;
            background-color: rgba(56, 224, 123, 0.1);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Role-specific badges */
        .role-badge-admin {
            background-color: #ef4444;
            color: white;
        }

        .role-badge-operator {
            background-color: #3b82f6;
            color: white;
        }

        .role-badge-viewer {
            background-color: #6b7280;
            color: white;
        }
    </style>
    <script src="{% static 'js/dataService.js' %}"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    {% block extra_head %}{% endblock %}
</head>

<body class="bg-gray-50 dark:bg-gray-900 font-sans text-gray-900 dark:text-gray-100" x-data="{ sidebarOpen: false }">

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside
            class="fixed inset-y-0 left-0 z-50 w-64 bg-emerald-900 text-white transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-auto"
            :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'">

            <!-- Logo -->
            <div class="flex items-center justify-center h-16 bg-emerald-950 shadow-md">
                <a href="{% url 'dashboard' %}" class="flex items-center gap-2 font-bold text-xl tracking-wider">
                    <span class="material-symbols-outlined text-emerald-400">hexagon</span>
                    METAMORPH
                </a>
            </div>

            <!-- Navigation -->
            <nav class="mt-5 px-4 space-y-2">
                <a href="{% url 'dashboard' %}"
                    class="flex items-center px-4 py-3 rounded-lg transition-colors {% if request.resolver_match.url_name == 'dashboard' %}bg-emerald-800 text-white{% else %}text-emerald-100 hover:bg-emerald-800{% endif %}">
                    <span class="material-symbols-outlined mr-3">dashboard</span>
                    Dashboard
                </a>

                <a href="{% url 'inventory' %}"
                    class="flex items-center px-4 py-3 rounded-lg transition-colors {% if request.resolver_match.url_name == 'inventory' %}bg-emerald-800 text-white{% else %}text-emerald-100 hover:bg-emerald-800{% endif %}">
                    <span class="material-symbols-outlined mr-3">inventory_2</span>
                    Inventory
                </a>

                {% if user.role == 'admin' or user.role == 'operator' %}
                <a href="{% url 'production' %}"
                    class="flex items-center px-4 py-3 rounded-lg transition-colors {% if request.resolver_match.url_name == 'production' %}bg-emerald-800 text-white{% else %}text-emerald-100 hover:bg-emerald-800{% endif %}">
                    <span class="material-symbols-outlined mr-3">precision_manufacturing</span>
                    Production
                </a>
                {% endif %}

                <a href="{% url 'qc' %}"
                    class="flex items-center px-4 py-3 rounded-lg transition-colors {% if request.resolver_match.url_name == 'qc' %}bg-emerald-800 text-white{% else %}text-emerald-100 hover:bg-emerald-800{% endif %}">
                    <span class="material-symbols-outlined mr-3">verified</span>
                    Quality Control
                </a>

                {% if user.role == 'admin' or user.role == 'operator' %}
                <a href="{% url 'utilities' %}"
                    class="flex items-center px-4 py-3 rounded-lg transition-colors {% if request.resolver_match.url_name == 'utilities' %}bg-emerald-800 text-white{% else %}text-emerald-100 hover:bg-emerald-800{% endif %}">
                    <span class="material-symbols-outlined mr-3">bolt</span>
                    Utilities
                </a>
                {% endif %}

                {% if user.role == 'admin' %}
                <div class="pt-4 pb-2">
                    <p class="px-4 text-xs font-semibold text-emerald-400 uppercase tracking-wider">Admin</p>
                </div>
                <a href="{% url 'user_management' %}"
                    class="flex items-center px-4 py-3 rounded-lg transition-colors {% if request.resolver_match.url_name == 'user_management' %}bg-emerald-800 text-white{% else %}text-emerald-100 hover:bg-emerald-800{% endif %}">
                    <span class="material-symbols-outlined mr-3">group</span>
                    Users
                </a>
                <a href="{% url 'system_settings' %}"
                    class="flex items-center px-4 py-3 rounded-lg transition-colors {% if request.resolver_match.url_name == 'system_settings' %}bg-emerald-800 text-white{% else %}text-emerald-100 hover:bg-emerald-800{% endif %}">
                    <span class="material-symbols-outlined mr-3">settings</span>
                    Settings
                </a>
                {% endif %}
            </nav>

            <!-- User Profile (Bottom) -->
            <div class="absolute bottom-0 w-full p-4 bg-emerald-950">
                <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                        <span
                            class="inline-block h-10 w-10 rounded-full bg-emerald-700 flex items-center justify-center text-white font-bold">
                            {{ user.username.0|upper }}
                        </span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-white truncate">{{ user.username }}</p>
                        <p class="text-xs text-emerald-400 truncate">{{ user.role|title }}</p>
                    </div>
                    <a href="{% url 'logout' %}" class="text-emerald-400 hover:text-white">
                        <span class="material-symbols-outlined">logout</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content Wrapper -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Header (Mobile Toggle & Context) -->
            <header
                class="flex items-center justify-between h-16 px-6 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center">
                    <button @click="sidebarOpen = !sidebarOpen" class="text-gray-500 focus:outline-none lg:hidden">
                        <span class="material-symbols-outlined">menu</span>
                    </button>
                    <h2 class="ml-4 text-xl font-semibold text-gray-800 dark:text-white lg:ml-0">
                        {% block header_title %}Overview{% endblock %}
                    </h2>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Theme Toggle -->
                    <button id="theme-toggle"
                        class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <span class="material-symbols-outlined dark:hidden">dark_mode</span>
                        <span class="material-symbols-outlined hidden dark:inline">light_mode</span>
                    </button>
                    <!-- Notifications (Placeholder) -->
                    <button
                        class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors relative">
                        <span class="material-symbols-outlined">notifications</span>
                        <span class="absolute top-2 right-2 h-2 w-2 bg-red-500 rounded-full"></span>
                    </button>
                </div>
            </header>

            <!-- Scrollable Main Content -->
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-50 dark:bg-gray-900 p-6">
                <!-- Role-based access messages -->
                {% if user.role == 'viewer' %}
                <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 rounded-r-lg">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-blue-500">visibility</span>
                        <p class="text-blue-700 dark:text-blue-300 text-sm">
                            <strong>Viewer Mode:</strong> Read-only access.
                        </p>
                    </div>
                </div>
                {% elif user.role == 'operator' %}
                <div class="mb-6 p-4 bg-emerald-50 dark:bg-emerald-900/20 border-l-4 border-emerald-500 rounded-r-lg">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-emerald-500">engineering</span>
                        <p class="text-emerald-700 dark:text-emerald-300 text-sm">
                            <strong>Operator Mode:</strong> Standard access.
                        </p>
                    </div>
                </div>
                {% endif %}

                {% block content %}{% endblock %}
            </main>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div x-show="sidebarOpen" @click="sidebarOpen = false"
            x-transition:enter="transition-opacity ease-linear duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-linear duration-300"
            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-gray-900/80 z-40 lg:hidden"></div>
    </div>

    <script>
        // Theme toggle functionality
        document.addEventListener('DOMContentLoaded', function () {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', function () {
                    if (document.documentElement.classList.contains('dark')) {
                        document.documentElement.classList.remove('dark');
                        localStorage.setItem('theme', 'light');
                    } else {
                        document.documentElement.classList.add('dark');
                        localStorage.setItem('theme', 'dark');
                    }
                });
            }

            // Check for saved theme preference
            if (localStorage.getItem('theme') === 'dark' ||
                (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    {% block extra_scripts %}{% endblock %}
</body>

</html>